<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hệ Thống Checksheet Điện - T.A Vietnam Industries</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary: #0056b3; --success: #28a745; --danger: #dc3545; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 25px; border-radius: 12px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        
        .nav { display: flex; gap: 10px; margin-bottom: 25px; border-bottom: 2px solid #eee; padding-bottom: 15px; }
        .nav button { padding: 12px 25px; border: none; cursor: pointer; border-radius: 6px; font-weight: bold; transition: 0.3s; }
        .nav button.active { background: var(--primary); color: white; }

        h2 { text-align: center; color: #333; margin-top: 0; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; font-size: 14px; }
        th { background: #f8f9fa; }

        .form-group { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        .btn-submit { background: var(--success); color: white; padding: 15px; width: 100%; border: none; border-radius: 6px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 20px; }
        .btn-excel { background: #217346; color: white; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
        
        .hidden { display: none; }
        .status-ok { color: var(--success); font-weight: bold; }
        .status-nok { color: var(--danger); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav">
        <button id="tabInput" class="active" onclick="switchTab('input')">NHẬP PHIẾU KIỂM TRA</button>
        <button id="tabHistory" onclick="switchTab('history')">DỮ LIỆU TỔNG HỢP (ADMIN)</button>
    </div>

    <div id="sectionInput">
        <h2>PHIẾU KIỂM TRA TỦ ĐIỆN HÀNG QUÝ [V02]</h2>
        <div class="form-group">
            <div>
                <label>Khu vực / Xưởng:</label>
                <input type="text" id="inpArea" placeholder="VD: Xưởng A">
            </div>
            <div>
                <label>Ngày thực hiện:</label>
                <input type="date" id="inpDate">
            </div>
        </div>

        <form id="checklistForm">
            <table>
                <thead>
                    <tr>
                        <th width="5%">STT</th>
                        <th width="40%">Nội dung kiểm tra</th>
                        <th width="20%">Kết quả</th>
                        <th>Ghi chú (Remarks)</th>
                    </tr>
                </thead>
                <tbody id="inputBody">
                    <tr><td>1</td><td>Kiểm tra ngoại quan hư hỏng vật lý (Cửa, cáp...)</td><td><select class="selRes"><option value="OK">Đạt (OK)</option><option value="NOK">Không Đạt (NOK)</option></select></td><td><input type="text" class="inpRem"></td></tr>
                    <tr><td>2</td><td>Tình trạng bụi bẩn, mạng nhện trong tủ</td><td><select class="selRes"><option value="OK">Đạt (OK)</option><option value="NOK">Không Đạt (NOK)</option></select></td><td><input type="text" class="inpRem"></td></tr>
                    <tr><td>3</td><td>Hiển thị đồng hồ và đèn báo pha</td><td><select class="selRes"><option value="OK">Đạt (OK)</option><option value="NOK">Không Đạt (NOK)</option></select></td><td><input type="text" class="inpRem"></td></tr>
                    <tr><td>4</td><td>Scan nhiệt (Tủ <50°C, Thiết bị <70°C)</td><td><select class="selRes"><option value="OK">Đạt (OK)</option><option value="NOK">Không Đạt (NOK)</option></select></td><td><input type="text" class="inpRem"></td></tr>
                    <tr><td>5</td><td>Đo điện trở cách điện (>2 MΩ)</td><td><select class="selRes"><option value="OK">Đạt (OK)</option><option value="NOK">Không Đạt (NOK)</option></select></td><td><input type="text" class="inpRem"></td></tr>
                </tbody>
            </table>
            <div style="margin-top:20px;">
                <label>Tên Kỹ thuật viên thực hiện:</label>
                <input type="text" id="inpTech" style="width:300px">
            </div>
            <button type="submit" class="btn-submit" id="btnSubmit">GỬI BÁO CÁO VỀ MÁY CHỦ</button>
        </form>
    </div>

    <div id="sectionHistory" class="hidden">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2>TỔNG HỢP KIỂM TRA HÀNG QUÝ</h2>
            <button class="btn-excel" onclick="exportToExcel()">XUẤT FILE EXCEL (.XLSX)</button>
        </div>
        <table id="adminTable">
            <thead>
                <tr>
                    <th>Ngày</th>
                    <th>Khu vực</th>
                    <th>Người làm</th>
                    <th>Kết quả tổng</th>
                    <th>Hành động</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
</div>

<script>
    // --- CẤU HÌNH FIREBASE MỚI CỦA BẠN ---
    const firebaseConfig = {
      apiKey: "AIzaSyDsnARYxNL1TrV_pCZGbijozM_DPhinbIg",
      authDomain: "checksheet-e294d.firebaseapp.com",
      projectId: "checksheet-e294d",
      storageBucket: "checksheet-e294d.firebasestorage.app",
      messagingSenderId: "587994708172",
      appId: "1:587994708172:web:0f9dcf6b9607f792d36a69"
    };

    // Khởi tạo
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // Chuyển tab
    function switchTab(target) {
        if(target === 'input') {
            document.getElementById('sectionInput').classList.remove('hidden');
            document.getElementById('sectionHistory').classList.add('hidden');
            document.getElementById('tabInput').classList.add('active');
            document.getElementById('tabHistory').classList.remove('active');
        } else {
            document.getElementById('sectionInput').classList.add('hidden');
            document.getElementById('sectionHistory').classList.remove('hidden');
            document.getElementById('tabInput').classList.remove('active');
            document.getElementById('tabHistory').classList.add('active');
            loadDataForAdmin();
        }
    }

    // Gửi dữ liệu lên máy chủ
    document.getElementById('checklistForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const submitBtn = document.getElementById('btnSubmit');
        submitBtn.disabled = true;
        submitBtn.innerText = "ĐANG ĐẨY DỮ LIỆU...";

        const results = [];
        document.querySelectorAll("#inputBody tr").forEach((row, index) => {
            results.push({
                stt: index + 1,
                res: row.querySelector(".selRes").value,
                rem: row.querySelector(".inpRem").value
            });
        });

        const dataPayload = {
            area: document.getElementById('inpArea').value,
            date: document.getElementById('inpDate').value,
            tech: document.getElementById('inpTech').value,
            items: results,
            serverTimestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection("QuarterlyChecksheets").add(dataPayload);
            alert("✅ Thành công! Dữ liệu đã được lưu trữ trên hệ thống.");
            e.target.reset();
        } catch (error) {
            console.error("Lỗi gửi dữ liệu:", error);
            alert("❌ Thất bại: Không thể kết nối máy chủ. Hãy kiểm tra Rules trong Firebase.");
        } finally {
            submitBtn.disabled = false;
            submitBtn.innerText = "GỬI BÁO CÁO VỀ MÁY CHỦ";
        }
    });

    // Tải dữ liệu cho Admin
    let rawDataStore = [];
    async function loadDataForAdmin() {
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = "<tr><td colspan='5'>Đang đồng bộ từ Firebase...</td></tr>";
        
        try {
            const snapshot = await db.collection("QuarterlyChecksheets").orderBy("serverTimestamp", "desc").get();
            tbody.innerHTML = "";
            rawDataStore = [];

            snapshot.forEach(doc => {
                const data = doc.data();
                rawDataStore.push(data);
                const isNok = data.items.some(i => i.res === "NOK");

                const row = `<tr>
                    <td>${data.date}</td>
                    <td>${data.area}</td>
                    <td>${data.tech}</td>
                    <td class="${isNok ? 'status-nok' : 'status-ok'}">${isNok ? 'CÓ LỖI (NOK)' : 'ĐẠT (OK)'}</td>
                    <td><button onclick="alert('Ghi chú: ' + '${data.items[0].rem || 'Trống'}')">Xem nhanh</button></td>
                </tr>`;
                tbody.innerHTML += row;
            });
        } catch (error) {
            tbody.innerHTML = "<tr><td colspan='5'>Lỗi tải dữ liệu. Hãy kiểm tra quyền truy cập Firestore.</td></tr>";
        }
    }

    // Xuất Excel cho người quản lý
    function exportToExcel() {
        if (rawDataStore.length === 0) return alert("Không có dữ liệu để xuất!");

        const excelContent = rawDataStore.map(d => ({
            "Ngày Kiểm Tra": d.date,
            "Khu Vực": d.area,
            "Người Thực Hiện": d.tech,
            "1. Ngoại quan": d.items[0].res,
            "2. Bụi bẩn": d.items[1].res,
            "3. Đồng hồ/Đèn": d.items[2].res,
            "4. Scan nhiệt": d.items[3].res,
            "5. Điện trở": d.items[4].res,
            "Ghi chú chi tiết": d.items.map(i => i.rem).filter(r => r).join(" | ")
        }));

        const ws = XLSX.utils.json_to_sheet(excelContent);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Checksheet_Data");
        XLSX.writeFile(wb, "Bao_Cao_Tong_Hop_Tu_Dien.xlsx");
    }
</script>

</body>
</html>
