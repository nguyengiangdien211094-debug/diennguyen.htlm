<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quản lý Kiểm tra Tủ điện - Rectorseal</title>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.17.1/firebase-firestore-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        :root { --primary-color: #0056b3; --success-color: #28a745; --danger-color: #dc3545; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: #e9ecef; margin: 0; padding: 20px; }
        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        
        /* Điều hướng */
        .nav-tabs { display: flex; gap: 10px; margin-bottom: 20px; border-bottom: 2px solid #ddd; padding-bottom: 10px; }
        .tab-btn { padding: 10px 20px; cursor: pointer; border: none; background: #ddd; border-radius: 5px; font-weight: bold; }
        .tab-btn.active { background: var(--primary-color); color: white; }

        h2 { text-align: center; color: #333; text-transform: uppercase; margin-bottom: 5px; }
        .subtitle { text-align: center; font-style: italic; color: #666; margin-bottom: 20px; }

        /* Form & Table */
        table { width: 100%; border-collapse: collapse; margin-top: 15px; background: #fff; }
        th, td { border: 1px solid #dee2e6; padding: 12px; text-align: left; }
        th { background-color: #f8f9fa; color: #333; }
        .section-hidden { display: none; }

        input, select { width: 100%; padding: 8px; box-sizing: border-box; border: 1px solid #ccc; border-radius: 4px; }
        .btn-group { margin-top: 20px; display: flex; gap: 10px; }
        .btn { padding: 10px 20px; border: none; border-radius: 5px; color: white; cursor: pointer; font-weight: bold; }
        .btn-save { background: var(--success-color); flex-grow: 1; }
        .btn-excel { background: #217346; } /* Màu Excel */
        .btn-refresh { background: #17a2b8; }

        .status-ok { color: var(--success-color); font-weight: bold; }
        .status-nok { color: var(--danger-color); font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <div class="nav-tabs">
        <button class="tab-btn active" onclick="showTab('input-section')">NHẬP PHIẾU MỚI</button>
        <button class="tab-btn" onclick="showTab('history-section')">LỊCH SỬ KIỂM TRA</button>
    </div>

    <div id="input-section">
        <h2>PHIẾU KIỂM TRA TỦ ĐIỆN HÀNG QUÝ </h2>
        <p class="subtitle">QUARTERLY ELECTRICAL CABINET CHECKLIST</p>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px;">
            <div>
                <label>Khu vực / Xưởng: </label>
                <input type="text" id="area" placeholder="Nhập tên xưởng...">
            </div>
            <div>
                <label>Ngày thực hiện:</label>
                <input type="date" id="checkDate">
            </div>
        </div>

        <form id="checklistForm">
            <table>
                <thead>
                    <tr>
                        <th width="5%">STT </th>
                        <th width="40%">Nội dung kiểm tra (Items) </th>
                        <th width="20%">Kết quả (Result) </th>
                        <th>Ghi chú (Remarks) </th>
                    </tr>
                </thead>
                <tbody id="inputBody">
                    <tr>
                        <td>1</td>
                        <td>Kiểm tra ngoại quan hư hỏng vật lý (tủ, cửa, cáp...) </td>
                        <td><select class="res"><option value="OK">Đạt (OK)</option><option value="NOK">Không Đạt (NOK)</option></select></td>
                        <td><input type="text" class="rem"></td>
                    </tr>
                    <tr>
                        <td>2</td>
                        <td>Tình trạng bụi bẩn, mạng nhện trong tủ </td>
                        <td><select class="res"><option value="OK">Đạt (OK)</option><option value="NOK">Không Đạt (NOK)</option></select></td>
                        <td><input type="text" class="rem"></td>
                    </tr>
                    <tr>
                        <td>3</td>
                        <td>Hiển thị đồng hồ (V, I, Kwh) và đèn báo </td>
                        <td><select class="res"><option value="OK">Đạt (OK)</option><option value="NOK">Không Đạt (NOK)</option></select></td>
                        <td><input type="text" class="rem"></td>
                    </tr>
                    <tr>
                        <td>4</td>
                        <td>Scan nhiệt thiết bị (<70°C) </td>
                        <td><select class="res"><option value="OK">Đạt (OK)</option><option value="NOK">Không Đạt (NOK)</option></select></td>
                        <td><input type="text" class="rem"></td>
                    </tr>
                    <tr>
                        <td>5</td>
                        <td>Đo điện trở cách điện (>2 MΩ) </td>
                        <td><select class="res"><option value="OK">Đạt (OK)</option><option value="NOK">Không Đạt (NOK)</option></select></td>
                        <td><input type="text" class="rem"></td>
                    </tr>
                </tbody>
            </table>
            
            <div style="margin-top: 15px;">
                <label>Kỹ thuật thực hiện: </label>
                <input type="text" id="technician" style="width: 250px; display: inline-block;">
            </div>

            <button type="submit" class="btn btn-save">LƯU PHIẾU KIỂM TRA</button>
        </form>
    </div>

    <div id="history-section" class="section-hidden">
        <h2>LỊCH SỬ DỮ LIỆU</h2>
        <div class="btn-group">
            <button class="btn btn-refresh" onclick="fetchData()">LÀM MỚI</button>
            <button class="btn btn-excel" onclick="exportToExcel()">XUẤT FILE EXCEL</button>
        </div>

        <table id="historyTable">
            <thead>
                <tr>
                    <th>Ngày</th>
                    <th>Xưởng</th>
                    <th>Người làm</th>
                    <th>Kết quả tổng quát</th>
                </tr>
            </thead>
            <tbody id="historyBody"></tbody>
        </table>
    </div>
</div>

<script>
    // --- CẤU HÌNH FIREBASE ---
    const firebaseConfig = {
        apiKey: "YOUR_API_KEY",
        authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
        projectId: "YOUR_PROJECT_ID",
        storageBucket: "YOUR_PROJECT_ID.appspot.com",
        messagingSenderId: "YOUR_SENDER_ID",
        appId: "YOUR_APP_ID"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // CHUYỂN TAB
    function showTab(tabId) {
        document.getElementById('input-section').classList.add('section-hidden');
        document.getElementById('history-section').classList.add('section-hidden');
        document.getElementById(tabId).classList.remove('section-hidden');
        
        document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
        event.currentTarget.classList.add('active');

        if(tabId === 'history-section') fetchData();
    }

    // LƯU DỮ LIỆU
    document.getElementById('checklistForm').addEventListener('submit', async (e) => {
        e.preventDefault();
        const results = [];
        document.querySelectorAll("#inputBody tr").forEach((row, i) => {
            results.push({
                stt: i + 1,
                result: row.querySelector(".res").value,
                remark: row.querySelector(".rem").value
            });
        });

        const data = {
            area: document.getElementById('area').value,
            date: document.getElementById('checkDate').value,
            technician: document.getElementById('technician').value,
            items: results,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            await db.collection("ElectricalChecklists").add(data);
            alert("Đã lưu thành công!");
            e.target.reset();
        } catch (err) { alert("Lỗi: " + err); }
    });

    // TẢI DỮ LIỆU LỊCH SỬ
    let allData = [];
    async function fetchData() {
        const tbody = document.getElementById('historyBody');
        tbody.innerHTML = "<tr><td colspan='4'>Đang tải...</td></tr>";
        
        const snapshot = await db.collection("ElectricalChecklists").orderBy("timestamp", "desc").get();
        tbody.innerHTML = "";
        allData = [];

        snapshot.forEach(doc => {
            const d = doc.data();
            allData.push(d);
            const hasNok = d.items.some(i => i.result === "NOK");
            const row = `<tr>
                <td>${d.date}</td>
                <td>${d.area}</td>
                <td>${d.technician}</td>
                <td class="${hasNok ? 'status-nok' : 'status-ok'}">${hasNok ? 'CÓ LỖI' : 'ĐẠT'}</td>
            </tr>`;
            tbody.innerHTML += row;
        });
    }

    // XUẤT EXCEL
    function exportToExcel() {
        if (allData.length === 0) return alert("Không có dữ liệu để xuất!");

        const excelRows = allData.map(d => ({
            "Ngày kiểm tra": d.date,
            "Khu vực": d.area,
            "Kỹ thuật viên": d.technician,
            "Mục 1 (Ngoại quan)": d.items[0].result,
            "Mục 2 (Bụi bẩn)": d.items[1].result,
            "Mục 3 (Đồng hồ/Đèn)": d.items[2].result,
            "Mục 4 (Nhiệt độ)": d.items[3].result,
            "Mục 5 (Điện trở)": d.items[4].result,
            "Ghi chú tổng hợp": d.items.map(i => i.remark).filter(r => r).join("; ")
        }));

        const worksheet = XLSX.utils.json_to_sheet(excelRows);
        const workbook = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(workbook, worksheet, "Checklist");
        XLSX.writeFile(workbook, "Bao_Cao_Kiem_Tra_Tu_Dien.xlsx");
    }
</script>

</body>
</html>
